<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | pepe2d</title>
    
    <!-- iOS Debug Styles -->
    <style>
        body {
            text-align: center;
            padding: 0;
            border: 0;
            margin: 0;
            overflow: hidden;
            background: #000;
        }
        
        #unity-canvas {
            width: 960px;
            height: 600px;
            background: #CCCCCC;
            position: relative;
            z-index: 1;
        }
        
        /* iOS Debug Overlay */
        #ios-debug-overlay {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            border: 2px solid red;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ª–∞–¥–∫–∏ */
        #debug-toggle-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            background: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10001;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ */
        #save-logs-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ iOS */
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        #progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 10001;
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö */
        .log-error { color: #ff4444; }
        .log-warn { color: #ffaa00; }
        .log-info { color: #44ff44; }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media only screen and (max-width: 768px) {
            #unity-canvas {
                width: 100% !important;
                height: 100% !important;
                position: fixed !important;
                top: 0;
                left: 0;
            }
            
            #ios-debug-overlay {
                width: 90%;
                max-height: 150px;
                right: 5%;
                top: 5%;
            }
            
            #save-logs-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏ -->
    <button id="debug-toggle-btn" onclick="toggleDebugOverlay()">DEBUG</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è iOS) -->
    <button id="save-logs-btn" onclick="saveLogsToFile()">üíæ SAVE LOGS</button>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
    <div id="progress-indicator">
        Loading: <span id="progress-text">0%</span>
    </div>
    
    <!-- –û–≤–µ—Ä–ª–µ–π –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="ios-debug-overlay">
        <div style="color: white; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 5px;">
            üçé iOS Debug Console
        </div>
        <div id="debug-output">Initializing...</div>
    </div>
    
    <!-- Canvas Unity -->
    <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
    
    <!-- –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ Unity -->
    <script src="Build/pepe.loader.js"></script>
    
    <!-- iOS Debug Script -->
    <script>
        // ===================== iOS DEBUG SYSTEM =====================
        (function() {
            'use strict';
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            const DEBUG_ENABLED = true;
            const MAX_LOGS = 500;
            const AUTO_SAVE_ON_CRASH = true;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
            const debugOverlay = document.getElementById('ios-debug-overlay');
            const debugOutput = document.getElementById('debug-output');
            const saveLogsBtn = document.getElementById('save-logs-btn');
            const progressText = document.getElementById('progress-text');
            
            // –•—Ä–∞–Ω–∏–ª–∏—â–µ –ª–æ–≥–æ–≤
            let logs = [];
            let unityProgress = 0;
            let loadingStuckCounter = 0;
            let lastProgress = 0;
            
            // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
            function initDebugSystem() {
                console.log('üîß Initializing iOS Debug System...');
                console.log('üì± Device:', navigator.userAgent);
                console.log('üçé iOS:', isIOS);
                console.log('üì≤ Mobile:', isMobile);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                if (isIOS) {
                    saveLogsBtn.style.display = 'block';
                    if (debugOverlay) debugOverlay.style.display = 'block';
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–≥–∏ –∏–∑ localStorage
                try {
                    const saved = localStorage.getItem('pepe_ios_logs');
                    if (saved) {
                        logs = JSON.parse(saved);
                        console.log(`üìÇ Restored ${logs.length} logs from storage`);
                    }
                } catch(e) {
                    console.error('Failed to restore logs:', e);
                }
                
                // –ü–µ—Ä–µ—Ö–≤–∞—Ç console.log
                hijackConsole();
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
                setupErrorHandlers();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                startProgressMonitoring();
                
                log('System', '‚úÖ Debug system initialized');
            }
            
            // ===== –ü–ï–†–ï–•–í–ê–¢ CONSOLE =====
            function hijackConsole() {
                const originalConsole = {
                    log: console.log,
                    error: console.error,
                    warn: console.warn,
                    info: console.info
                };
                
                ['log', 'error', 'warn', 'info'].forEach(method => {
                    console[method] = function(...args) {
                        // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
                        originalConsole[method].apply(console, args);
                        
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        const message = args.map(arg => 
                            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                        ).join(' ');
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥
                        addLog(method, message);
                    };
                });
            }
            
            // ===== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö =====
            function setupErrorHandlers() {
                // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ JavaScript
                window.addEventListener('error', function(e) {
                    const errorMsg = `JS Error: ${e.message} at ${e.filename}:${e.lineno}`;
                    addLog('error', errorMsg);
                    if (e.error && e.error.stack) {
                        addLog('error', 'Stack: ' + e.error.stack);
                    }
                    
                    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
                    if (AUTO_SAVE_ON_CRASH && e.message.includes('WebGL') || e.message.includes('memory')) {
                        setTimeout(() => {
                            if (confirm('Game error detected! Save debug logs?')) {
                                saveLogsToFile();
                            }
                        }, 1000);
                    }
                });
                
                // Unhandled promise rejections
                window.addEventListener('unhandledrejection', function(e) {
                    addLog('error', `Unhandled Promise: ${e.reason}`);
                });
            }
            
            // ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –õ–û–ì–ê =====
            function addLog(type, message) {
                const logEntry = {
                    type: type,
                    message: message.substring(0, 500), // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                    timestamp: new Date().toISOString(),
                    progress: unityProgress,
                    isIOS: isIOS,
                    userAgent: navigator.userAgent
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                logs.push(logEntry);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
                if (logs.length > MAX_LOGS) {
                    logs = logs.slice(-MAX_LOGS);
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ –æ–≤–µ—Ä–ª–µ–µ
                if (debugOutput && debugOverlay.style.display !== 'none') {
                    const line = document.createElement('div');
                    line.className = 'log-' + type;
                    line.textContent = `[${type.toUpperCase()}] ${message.substring(0, 80)}`;
                    debugOutput.appendChild(line);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
                    while (debugOutput.children.length > 15) {
                        debugOutput.removeChild(debugOutput.firstChild);
                    }
                    
                    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
                    debugOutput.scrollTop = debugOutput.scrollHeight;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveLogsToStorage();
                
                return logEntry;
            }
            
            // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –í STORAGE =====
            function saveLogsToStorage() {
                try {
                    localStorage.setItem('pepe_ios_logs', JSON.stringify(logs));
                } catch(e) {
                    console.warn('Failed to save logs to storage:', e);
                }
            }
            
            // ===== –ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–†–û–ì–†–ï–°–°–ê =====
            function startProgressMonitoring() {
                setInterval(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    if (progressText) {
                        progressText.textContent = Math.round(unityProgress * 100) + '%';
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∞–Ω–∏–µ
                    if (Math.abs(unityProgress - lastProgress) < 0.001 && unityProgress > 0.1) {
                        loadingStuckCounter++;
                        
                        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏
                        if (loadingStuckCounter === 30) { // 30 —Å–µ–∫—É–Ω–¥
                            addLog('warn', `‚ö†Ô∏è Loading stuck at ${Math.round(unityProgress * 100)}% for 30s`);
                        }
                        
                        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–∏—Å–∞–Ω–∏–µ –Ω–∞ 90%
                        if (unityProgress >= 0.9 && unityProgress < 0.91 && loadingStuckCounter > 60) {
                            addLog('error', `üö® CRITICAL: Stuck at 90% for 60s! iOS likely hanging`);
                            if (isIOS && confirm('Game seems stuck! Save debug logs?')) {
                                saveLogsToFile();
                            }
                        }
                    } else {
                        loadingStuckCounter = 0;
                    }
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –≤–∞–∂–Ω—ã–µ —ç—Ç–∞–ø—ã
                    if (Math.floor(unityProgress * 10) > Math.floor(lastProgress * 10)) {
                        addLog('info', `Loading progress: ${Math.round(unityProgress * 100)}%`);
                    }
                    
                    // –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ 90%
                    if (unityProgress >= 0.9 && unityProgress < 0.91 && lastProgress < 0.9) {
                        addLog('warn', 'üéØ REACHED 90% - Critical point for iOS');
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                        const diagnostics = {
                            screen: `${screen.width}x${screen.height}`,
                            memory: performance.memory ? {
                                used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                                limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) + 'MB'
                            } : 'N/A',
                            device: navigator.userAgent
                        };
                        
                        addLog('info', 'iOS Diagnostics: ' + JSON.stringify(diagnostics));
                    }
                    
                    lastProgress = unityProgress;
                    
                }, 1000);
            }
            
            // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –í –§–ê–ô–õ =====
            window.saveLogsToFile = function() {
                try {
                    if (logs.length === 0) {
                        alert('No logs to save!');
                        return;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç –ª–æ–≥–æ–≤
                    let logText = '=== PEPE2D iOS DEBUG LOG ===\n';
                    logText += `Time: ${new Date().toISOString()}\n`;
                    logText += `Device: ${navigator.userAgent}\n`;
                    logText += `iOS: ${isIOS}\n`;
                    logText += `Screen: ${screen.width}x${screen.height}\n`;
                    logText += `URL: ${window.location.href}\n`;
                    logText += `Total logs: ${logs.length}\n\n`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ª–æ–≥–∏
                    logs.forEach(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        logText += `[${time}] [${log.type.toUpperCase()}] ${log.message}\n`;
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –≤ alert
                    const recentLogs = logs.slice(-10).map(log => 
                        `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message.substring(0, 50)}`
                    ).join('\n');
                    
                    // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    const blob = new Blob([logText], {type: 'text/plain;charset=utf-8'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `pepe_ios_logs_${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    alert(`‚úÖ Logs saved!\n\nRecent activity:\n${recentLogs}`);
                    
                } catch(error) {
                    console.error('Error saving logs:', error);
                    alert('Error saving logs: ' + error.message);
                }
            };
            
            // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
            window.toggleDebugOverlay = function() {
                if (debugOverlay) {
                    debugOverlay.style.display = debugOverlay.style.display === 'none' ? 'block' : 'none';
                }
            };
            
            window.log = addLog;
            window.getLogs = () => [...logs];
            window.clearLogs = () => {
                logs = [];
                saveLogsToStorage();
                if (debugOutput) debugOutput.innerHTML = '';
            };
            
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            window.updateUnityProgress = function(progress) {
                unityProgress = progress;
            };
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
            if (DEBUG_ENABLED) {
                document.addEventListener('DOMContentLoaded', initDebugSystem);
            }
            
        })();
        
        // ===================== UNITY INITIALIZATION =====================
        (function() {
            // –ú–æ–±–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.getElementsByTagName('head')[0].appendChild(meta);
                
                var canvas = document.querySelector("#unity-canvas");
                canvas.style.width = "100%";
                canvas.style.height = "100%";
                canvas.style.position = "fixed";
                
                document.body.style.textAlign = "left";
            }
            
            // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Unity
            createUnityInstance(document.querySelector("#unity-canvas"), {
                arguments: [],
                dataUrl: "Build/pepe.data.unityweb",
                frameworkUrl: "Build/pepe.framework.js.unityweb",
                codeUrl: "Build/pepe.wasm.unityweb",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "DefaultCompany",
                productName: "pepe2d",
                productVersion: "1.0",
            }).then((unityInstance) => {
                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ Unity
                if (unityInstance.Module && unityInstance.Module.onProgress) {
                    unityInstance.Module.onProgress = function(progress) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º–µ –æ—Ç–ª–∞–¥–∫–∏
                        if (window.updateUnityProgress) {
                            window.updateUnityProgress(progress);
                        }
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                        if (progress === 1) {
                            setTimeout(() => {
                                const indicator = document.getElementById('progress-indicator');
                                if (indicator) indicator.style.display = 'none';
                            }, 1000);
                        }
                    };
                }
                
                // –ö–æ–≥–¥–∞ Unity –≥–æ—Ç–æ–≤
                if (unityInstance.Module && unityInstance.Module.onRuntimeInitialized) {
                    unityInstance.Module.onRuntimeInitialized = function() {
                        console.log('‚úÖ Unity runtime initialized successfully!');
                        if (window.log) {
                            window.log('System', 'Unity runtime ready');
                        }
                    };
                }
                
            }).catch((message) => {
                console.error('Unity initialization failed:', message);
                if (window.log) {
                    window.log('error', 'Unity failed: ' + message);
                }
                alert('Game loading failed: ' + message);
            });
        })();
    </script>
    
    <!-- QR –∫–æ–¥ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –Ω–∞ iOS -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/qrcode.min.js"></script>
    <script>
        // –î–æ–±–∞–≤–ª—è–µ–º QR –∫–æ–¥ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è iOS –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
            setTimeout(() => {
                const qrDiv = document.createElement('div');
                qrDiv.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    background: white;
                    padding: 10px;
                    border-radius: 10px;
                    z-index: 10002;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    font-size: 12px;
                `;
                qrDiv.innerHTML = '<div style="margin-bottom:5px; color:#333;">If game hangs:</div>';
                
                const qrContainer = document.createElement('div');
                qrDiv.appendChild(qrContainer);
                document.body.appendChild(qrDiv);
                
                new QRCode(qrContainer, {
                    text: 'Press the RED SAVE LOGS button below to save debug information',
                    width: 100,
                    height: 100
                });
            }, 5000);
        }
    </script>
</body>
</html>
